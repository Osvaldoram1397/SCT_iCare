@model IEnumerable<SCT_iCare.Paciente>

@{
    ViewBag.Title = "Index";

    var oUser = (Usuarios)HttpContext.Current.Session["User"];

    GMIEntities db = new GMIEntities();
    System.Web.Script.Serialization.JavaScriptSerializer js = new System.Web.Script.Serialization.JavaScriptSerializer();

    var Recepcion = new int?();
    var Hospital = "";
    var idHospital = 0;
    string Sucursal = null;
    int idUser = 14;
    string nombreUsuario = null;
    string fila = "";
    int registros;

    int flag = 1; //contador de la tabla

    DateTime start = DateTime.Now;
    DateTime finish = DateTime.Now.AddDays(1);

    int year = start.Year;
    int month = start.Month;
    int day = start.Day;

    int year1 = finish.Year;
    int month1 = finish.Month;
    int day1 = finish.Day;

    int tomorrorDay = day + 1;
    DateTime thisDate = new DateTime(year, month, day);
    DateTime tomorrowDate = new DateTime(year1, month1, day1);

    var modelo = db.PacienteESP.Where(s => s.FechaCita >= thisDate && s.FechaCita < tomorrowDate && s.NoExpediente != null && s.Doctor != null && s.Asistencia == null && s.Estatura != null
    && s.Metra != null);
    int? idRol = 0;

    if (oUser != null)
    {
        idUser = oUser.idUsuario;
        nombreUsuario = oUser.Nombre;
        idRol = oUser.idRol;

        if (idUser != 14 && oUser.idRol != 2)
        {
            Recepcion = (from r in db.Recepcionista where r.idUsuario == idUser select r.idSucursal).FirstOrDefault();
            Hospital = (from h in db.Sucursales where h.idSucursal == Recepcion select h.Nombre).FirstOrDefault();
            idHospital = (from h in db.Sucursales where h.idSucursal == Recepcion select h.idSucursal).FirstOrDefault();
            Sucursal = Hospital.ToString();

            registros = db.Paciente.Join(db.Cita, n => n.Folio, m => m.Folio, (n, m) => new { N = n, M = m }).Where(s => s.M.FechaCita >= thisDate && s.M.FechaCita < tomorrowDate && s.M.Sucursal == Sucursal).Count();

        }
        else
        {
            Hospital = "GENERAL";
            Sucursal = Hospital.ToString();

            registros = db.Paciente.Join(db.Cita, n => n.Folio, m => m.Folio, (n, m) => new { N = n, M = m }).Where(s => s.M.FechaCita >= thisDate && s.M.FechaCita < tomorrowDate).Count();

        }
    }

}

<br />
<br />
<h3 style="color:#AC9070" class="text-center"><span style="color:white"><a style="text-decoration:none; color:white; cursor:pointer">Centro de Captura</a></span></h3>
@*<button type="button" class="btn btn-success" data-toggle="modal" data-target="#exampleModal"><span class="glyphicon glyphicon-plus"></span> Cita con Pago</button>
    <button type="button" class="btn btn-warning" data-toggle="modal" data-target="#exampleModal2"><span class="glyphicon glyphicon-plus"></span> Crear Referecia de Pago</button>*@


@section scripts{

    <script>
        var input = document.getElementById("buscador");
        input.addEventListener("keyup", function (event) {
            if (event.keyCode === 13) {
                event.preventDefault();
                document.getElementById("buscar").click();
            }
        });

    </script>

    <script>
    $(function () {
        $(".buscar").click(function () {
            var url = "@Url.Action("Buscar", "Recepcion")";
            var dato = $("#buscador").val();
            var data = { dato: dato };

            $.post(url, data).done(function (data) {
                console.log(data);
                let miResultado = "";
                if ($.isEmptyObject(data)) {
                    miResultado = "<h3>No se encontraron registros!!</h3>"
                }
                else {
                    miResultado +=  "<tr class=\"bg-primary\"><th>Nombre</th><th>Sucursal</th><th>Tipo Tramite</th><th>Tipo Licencia</th><th>Estatus Dictamen</th><th>Fecha Cita</th><th></th></tr>"
                    for (let i = 0; i < data.length; i++) {

                        if (data[i].EstatusDictamen == null) {
                            miResultado += "<tr style=\"border:1px solid gray\">" +
                                "<td><b>" + data[i].Nombre + "</b></td>" +
                                "<td><b>" + data[i].Sucursal + "</b></td>" +
                                "<td><b>" + data[i].TipoTramite + "</b></td>" +
                                "<td><b>" + data[i].TipoLicencia + "</b></td>" +
                                "<td><b>Pendiente</b></td>" +
                                "<td><b>" + data[i].FechaCita + "</b></td>" +
                                "</tr>"

                        } else {
                            miResultado += "<tr style=\"border:1px solid gray\">" +
                                "<td><b>" + data[i].Nombre + "</b></td>" +
                                "<td><b>" + data[i].Sucursal + "</b></td>" +
                                "<td><b>" + data[i].TipoTramite + "</b></td>" +
                                "<td><b>" + data[i].TipoLicencia + "</b></td>" +
                                "<td><b>" + data[i].EstatusDictamen + "</b></td>" +
                                "<td><b>" + data[i].FechaCita + "</b></td>" +
                                "</tr>"

                        }

                    }
                }

                $('#exampleModal5').modal('show');
                document.getElementById("tablaEjemploSS").innerHTML = miResultado;

            }).fail().always(function () {

            });
        });
    });
    </script>

    @if (TempData["Link"] != null)
    {
        <script>
            @*location.href='@Url.Action("AbrirEPI","EPIs", new { id = TempData["ID"] })';*@
            window.open('@TempData["Link"]');
        </script>
    }



    @if (TempData["Electro"] != null)
    {
        <script>
            window.open('@Url.Action("DescargarElectro","Dictamenes")');
        </script>
    }

    @if (TempData["Documentos"] != null)
    {
        <script>
            window.open('@Url.Action("DescargarDocumentos","Dictamenes", new { id = TempData["Documentos"] })');
        </script>
    }

    @if (TempData["NoAccidentes"] != null)
    {
        <script>
            window.open('@Url.Action("DescargarNoAccidentes","Dictamenes", new { id = TempData["NoAccidentes"] })');
        </script>
    }

    @if (TempData["Declaracion"] != null)
    {
        <script>
            window.open('@Url.Action("DescargarDeclaracion","Dictamenes", new { id = TempData["Declaracion"] })');
        </script>
    }

    @if (TempData["Glucosilada"] != null)
    {
        <script>
            window.open('@Url.Action("DescargarGlucosilada","Dictamenes", new { id = TempData["Glucosilada"] })');
        </script>
    }
}

<br />


@if (modelo.FirstOrDefault() == null)
{
    <br />
    <h1 style="color:white">No existen citas registradas el día de hoy</h1>
}
else
{
    <div class="tablaScroll">
        <br />
        <table class="table tablas" style="color: #2F2D6B">
            <thead>
                <tr class="bg-primary" style="border-top-color: black; font-size:smaller">
                    <th>
                    </th>

                    <th>
                        Nombre
                    </th>

                    <th>
                        NoExpediente
                    </th>
                    <th>Sucursal</th>
                    <th>
                        Doctor
                    </th>

                    <th>
                        Tipo de Trámite
                    </th>
                    <th>
                        Estatus
                    </th>
                    <th>
                        Capturista
                    </th>
                    <th></th>
                </tr>
            </thead>


            @foreach (var item in modelo)
            {

                if (item.TipoTramite == "PRIMERA VEZ" && item.TipoLicencia != "AEREO")
                {
                    fila = "#BBDEFB";
                }
                else if (item.TipoTramite != "PRIMERA VEZ" && item.TipoLicencia == "AEREO")
                {
                    fila = "#D1C4E9";
                }
                else if (item.TipoTramite == "PRIMERA VEZ" && item.TipoLicencia == "AEREO")
                {
                    fila = "#9575CD";
                }
                else
                {
                    fila = "white";
                }

                <tr style="background-color:@fila">
                    <td>
                        @flag
                    </td>

                    <td>
                        <b>@Html.DisplayFor(modelItem => item.Nombre) </b>

                        @if (item.Entregado != null)
                        {
                            <span class="glyphicon glyphicon-thumbs-up"></span>
                        }
                    </td>

                    <td>
                        <b>@Html.DisplayFor(modelItem => item.NoExpediente)</b>
                    </td>
                    <td>
                        <b>@Html.DisplayFor(modelItem => item.Sucursal)</b>
                    </td>
                    <td>
                        <b>@Html.DisplayFor(modelItem => item.Doctor)</b>
                    </td>
                    <td>
                        <b>@Html.DisplayFor(modelItem => item.TipoTramite)</b><br /> (@item.TipoLicencia)
                    </td>
                    <td style="font-size: smaller">
                        <b>@item.EstatusCaptura.ToUpper()</b>
                    </td>
                    <td style="font-size: smaller">
                        <span>@item.Capturista</span>
                    </td>
                    <td>
                        <div class="btn-group">

                            @{
                                if (item.Asistencia == null)
                                {
                                    <button type="button" class="btn btn-info dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                        Acciones <span class="glyphicon glyphicon-triangle-bottom"></span>
                                    </button>
                                }

                        <div class="dropdown-menu" style="padding:10px">
                            @{
                                var revisionFoto2 = (from i in db.FotoPacienteESP where i.idPacienteESP == item.idPacienteESP select i.idPacienteESP).FirstOrDefault();
                                var revisionDocumentos2 = (from i in db.DocumentosESP where i.idPacienteESP == item.idPacienteESP select i.idPacienteESP).FirstOrDefault();
                                var revisionCartaNO2 = (from i in db.CartaNoAccidentesESP where i.idPacienteESP == item.idPacienteESP select i.idPacienteESP).FirstOrDefault();
                                var revisionDeclaracion2 = (from i in db.DeclaracionSaludESP where i.idPacienteESP == item.idPacienteESP select i.idPacienteESP).FirstOrDefault();
                                var revisionGlucosilada2 = (from i in db.HemoglobinaGlucosiladaESP where i.idPacienteESP == item.idPacienteESP select i.idPacienteESP).FirstOrDefault();

                                <a href="#" data-toggle="modal" data-target="#DescargarEPI_@item.idPacienteESP"><b>Descargar EPI</b></a>
                                <div class="dropdown-divider"></div>
                                @*<a href="#" data-toggle="modal" data-target="#DescargarEKG_@item.idPacienteESP">Electrocardiograma</a>*@
                                <b>@Html.ActionLink("Descargar EKG", "AbrirElectro", null, new { style = "color: cadetblue; text-decoration: none" })</b>
                                <div class="dropdown-divider"></div>
                                @*<a href="#" data-toggle="modal" data-target="#DescargarDocumentos_@item.idPacienteESP">Documentación</a>*@
                                <b>@Html.ActionLink("Documentos", "AbrirDocumentos", new { id = item.idPacienteESP }, new { style = "color: cadetblue; text-decoration: none" })</b>
                                <div class="dropdown-divider"></div>

                                if (revisionCartaNO2 != null)
                                {
                                    @*<a href="#" data-toggle="modal" data-target="#DescargarNoAccidentes_@item.idPacienteESP">Carta NoAccidentes</a>*@
                                    <b>@Html.ActionLink("Carta NoAccidentes", "AbrirNoAccidenres", new { id = item.idPacienteESP }, new { style = "color: cadetblue; text-decoration: none" })</b>
                                    <div class="dropdown-divider"></div>
                                }
                                if (revisionDeclaracion2 != null)
                                {
                                    @*<a href="#" data-toggle="modal" data-target="#DescargarDeclaracionSalud_@item.idPacienteESP">Declaración Salud</a>*@
                                    <b>@Html.ActionLink("Declaración Salud", "AbrirDeclaracion", new { id = item.idPacienteESP }, new { style = "color: cadetblue; text-decoration: none" })</b>
                                    <div class="dropdown-divider"></div>
                                }
                                if (revisionGlucosilada2 != null)
                                {
                                    @*<a href="#" data-toggle="modal" data-target="#DescargarGlucosilada_@item.idPacienteESP">H. Glucosilada</a>*@
                                    <b>@Html.ActionLink("H.Glucosilada", "AbrirGlucosilada", new { id = item.idPacienteESP }, new { style = "color: cadetblue; text-decoration: none" })</b>
                                    <div class="dropdown-divider"></div>
                                }
                            }
                        </div>

                            }

                            <!-- -------------------------------------------------------------------------------------------------------------- -->
                            <!-- Modal para Completar Datos -->
                            <form method="post" enctype="multipart/form-data" action="@Url.Content("~/Dictamenes/CompletarDatos")">
                                @Html.AntiForgeryToken()
                                <div class="modal fade" id="CompletarDatos_@item.idPacienteESP" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
                                    <div class="modal-dialog" role="document">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                @{
                                                    var revisionTL = (from i in db.PacienteESP where i.idPacienteESP == item.idPacienteESP select i).FirstOrDefault();

                                                    if (revisionTL.TipoLicencia == "AEREO")
                                                    {
                                                        <h4 class="modal-title text-danger" id="exampleModalLabel"><b>Completar Datos (Paciente Aereo)</b></h4>
                                                    }
                                                    else
                                                    {
                                                        <h4 class="modal-title text-primary" id="exampleModalLabel"><b>Completar Datos</b></h4>
                                                    }
                                                }

                                            </div>
                                            <div class="modal-body">
                                                <div class="form-group">
                                                    <label for="recipient-name" class="col-form-label">Nombre del Paciente:</label>
                                                    <input type="text" class="form-control" id="nombre" name="nombre" placeholder="@item.Nombre">
                                                </div>
                                                <div class="form-group">
                                                    <label for="recipient-name" class="col-form-label">CURP (Clave Única de Registro de Población):</label>
                                                    @{
                                                        if (item.CURP == null)
                                                        {
                                                            <input type="text" class="form-control" id="curp" name="curp" maxlength="18" />
                                                        }
                                                        else
                                                        {
                                                            <input type="text" class="form-control" id="curp" name="curp" maxlength="18" value="@item.CURP" placeholder="@item.CURP" />
                                                        }
                                                    }
                                                    <input type="hidden" class="form-control" id="id" name="id" value="@item.idPacienteESP">
                                                </div>
                                                <div class="form-group">
                                                    <label for="recipient-name" class="col-form-label">Estatura (en cms):</label>
                                                    @{
                                                        if (item.Estatura == null)
                                                        {
                                                            <input type="number" class="form-control" id="curp" name="estatura" />
                                                        }
                                                        else
                                                        {
                                                            <input type="number" class="form-control" id="curp" name="estatura" maxlength="18" value="@item.Estatura" placeholder="@item.Estatura" />
                                                        }
                                                    }
                                                    <input type="hidden" class="form-control" id="id" name="id" value="@item.idPacienteESP">
                                                </div>
                                                <div class="form-group">
                                                    <label for="recipient-name" class="col-form-label">No. de Expediente:</label>
                                                    @{
                                                        if (item.NoExpediente == null)
                                                        {
                                                            <input type="text" class="form-control" id="numero" name="numero" />
                                                        }
                                                        else
                                                        {
                                                            <input type="text" class="form-control" id="numero" name="numero" value="@item.NoExpediente" placeholder="@item.NoExpediente" />
                                                        }
                                                    }
                                                </div>
                                                <div class="form-group">
                                                    <label for="recipient-name" class="col-form-label">Doctor Dictaminador:</label>
                                                    <select name="doctor" style="width:100%; min-height:5vh; min-width:99%; font-size:2vh" class="form-select">
                                                        @{
                                                            var consultorios1 = from c in db.Doctores select c;
                                                            var revisionD = (from i in db.PacienteESP where i.idPacienteESP == item.idPacienteESP select i).FirstOrDefault();

                                                            if (revisionD.Doctor != null)
                                                            {
                                                                <option style="font-weight:bold" value="@revisionTL.Doctor" selected>@revisionTL.Doctor</option>
                                                                <option disabled>----------------------------------------------</option>
                                                            }

                                                            foreach (var item1 in consultorios1)
                                                            {
                                                                <option style="font-weight:bold" value="@item1.Nombre">@item1.Nombre</option>
                                                            }

                                                        }
                                                    </select>
                                                </div>
                                                @{
                                                    var consultaAereo1 = (from c in db.PacienteESP where c.idPacienteESP == item.idPacienteESP select c.TipoLicencia).FirstOrDefault();
                                                    if (consultaAereo1 == "AEREO")
                                                    {
                                                        <input type="hidden" name="tipoL" id="tipoL" value="AEREO" />
                                                    }
                                                    else
                                                    {
                                                        <div class="form-group" style="width:80%; min-width:320px">
                                                            <label for="recipient-name" class="col-form-label">Tipo de Licencia:</label>
                                                            <select name="tipoL" style="width:100%; min-height:5vh; min-width:99%; font-size:2vh" class="form-select">

                                                                @{
                                                                    var revisionTL2 = (from i in db.PacienteESP where i.idPacienteESP == item.idPacienteESP select i).FirstOrDefault();

                                                                    if (revisionTL2.TipoLicencia != null)
                                                                    {
                                                                        <option value="@revisionTL2.TipoLicencia" selected>@revisionTL2.TipoLicencia</option>
                                                                        <option disabled>----------------------------------------</option>
                                                                        <option value="AUTOTRANSPORTE">AUTOTRANSPORTE</option>
                                                                        <option value="MARITIMO">MARITIMO</option>
                                                                        <option value="FERROVIARIO">FERROVIARIO</option>
                                                                    }
                                                                    else
                                                                    {
                                                                        <option value="AUTOTRANSPORTE">AUTOTRANSPORTE</option>
                                                                        <option value="MARITIMO">MARITIMO</option>
                                                                        <option value="FERROVIARIO">FERROVIARIO</option>
                                                                    }
                                                                }
                                                            </select>
                                                        </div>
                                                    }
                                                }

                                                <div class="form-group" style="width:80%; min-width:320px">
                                                    <label for="recipient-name" class="col-form-label">Tipo de Trámite:</label>
                                                    <select name="tipoT" style="width:100%; min-height:5vh; min-width:99%; font-size:2vh" class="form-select">
                                                        @{
                                                            var revisionTT = (from i in db.PacienteESP where i.idPacienteESP == item.idPacienteESP select i.TipoTramite).FirstOrDefault();

                                                            if (revisionTT != null)
                                                            {
                                                                <option value="@revisionTT" selected>@revisionTT</option>
                                                                <option disabled>----------------------------------------</option>
                                                                <option value="REVALIDACIÓN">REVALIDACIÓN</option>
                                                                <option value="PRIMERA VEZ">PRIMERA VEZ</option>
                                                            }
                                                            else
                                                            {
                                                                <option value="REVALIDACIÓN">REVALIDACIÓN</option>
                                                                <option value="PRIMERA VEZ">PRIMERA VEZ</option>
                                                            }
                                                        }
                                                    </select>
                                                </div>
                                                <hr />
                                                <div class="form-group">
                                                    <label for="file" class="col-form-label">Capturar Foto:</label>
                                                    <input type="file" name="file" capture="camera" />
                                                </div>
                                                <br />
                                                <div class="form-group">
                                                    <label for="file" class="col-form-label">Cargar Documentos del Paciente:</label>
                                                    <input type="file" name="documentos" />
                                                </div>
                                                <hr />
                                                <div class="form-group">
                                                    <label for="file" class="col-form-label">Cargar Declaración de Salud:</label>
                                                    <input type="file" name="declaracion" />
                                                </div>
                                                <hr />
                                                <div class="form-group">
                                                    <label for="file" class="col-form-label">Cargar Carta de NO ACCIDENTES (sólo si aplica):</label>
                                                    <input type="file" name="carta" />
                                                </div>
                                                <hr />
                                                <div class="form-group">
                                                    <label for="file" class="col-form-label">Hemoglobina Glucosilada (sólo si aplica):</label>
                                                    <input type="file" name="glucosilada" />
                                                </div>
                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
                                                <input type="submit" value="Guardar" class="btn btn-primary" />
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </form>

                        </div>

                    </td>
                </tr>

                flag += 1;

            }

        </table>
    </div>
}


