
@{
    ViewBag.Title = "Administrador";

    GMIEntities db = new GMIEntities();

    var sucursalesLista = from s in db.Sucursales select s;

    int diaHoy = DateTime.Now.Day;
    int mesHoy = DateTime.Now.Month;
    int anioHoy = DateTime.Now.Year;

    DateTime dateToday = new DateTime(anioHoy, mesHoy, diaHoy);

    int diaManana = DateTime.Now.AddDays(1).Day;
    int mesManana = DateTime.Now.AddDays(1).Month;
    int anioManana = DateTime.Now.AddDays(1).Year;

    DateTime dateTomorrow = new DateTime(anioManana, mesManana, diaManana);

    var citasHoy = (from c in db.Cita select c).Where(w => w.FechaCita >= dateToday && w.FechaCita < dateTomorrow);
    int citasHoyConteo = (from c in db.Cita select c).Where(w => w.FechaCita >= dateToday && w.FechaCita < dateTomorrow).Count();

    var episHoy = (from c in db.Captura select c).Where(w => w.FechaExpdiente >= dateToday && w.FechaExpdiente < dateTomorrow);
    int episHoyConteo = (from c in db.Captura select c).Where(w => w.FechaExpdiente >= dateToday && w.FechaExpdiente < dateTomorrow).Count();

    var dictamenHoy = (from c in db.Captura select c).Where(w => w.FechaExpdiente >= dateToday && w.FechaExpdiente < dateTomorrow && w.EstatusCaptura == "Terminado");
    int dictamenHoyConteo = (from c in db.Captura select c).Where(w => w.FechaExpdiente >= dateToday && w.FechaExpdiente < dateTomorrow && w.EstatusCaptura == "Terminado").Count();

    var enProcesoHoy = (from c in db.Captura select c).Where(w => w.FechaExpdiente >= dateToday && w.FechaExpdiente < dateTomorrow && (w.EstatusCaptura == "En captura..." || w.EstatusCaptura == "No iniciado"));
    int enProcesoHoyConteo = (from c in db.Captura select c).Where(w => w.FechaExpdiente >= dateToday && w.FechaExpdiente < dateTomorrow && (w.EstatusCaptura == "En captura..." || w.EstatusCaptura == "No iniciado")).Count();

    var pendientesHoy = (from c in db.Captura select c).Where(w => w.FechaExpdiente >= dateToday && w.FechaExpdiente < dateTomorrow && w.EstatusCaptura == "Pendiente");
    int pendientesHoyConteo = (from c in db.Captura select c).Where(w => w.FechaExpdiente >= dateToday && w.FechaExpdiente < dateTomorrow && w.EstatusCaptura == "Pendiente").Count();

    var entregados = (from c in db.Cita select c).Where(w => w.FechaCita >= dateToday && w.FechaCita < dateTomorrow && w.Entregado == "SI");
    int entregadosConteo = (from c in db.Cita select c).Where(w => w.FechaCita >= dateToday && w.FechaCita < dateTomorrow && w.Entregado == "SI").Count();

    var enviados = db.Cita.Join(db.DictamenProblema, n => n.idPaciente, m => m.idPaciente, (n, m) => new { N = n, M = m })
                .Where(w => w.N.FechaCita >= dateToday && w.N.FechaCita < dateTomorrow && w.M.EstatusEnvio == "SI")
                .Select(S => new
                {
                    S.N.Sucursal,
                    S.N.FechaCita,
                    S.M.EstatusEnvio
                });

    int enviadosCount = db.Cita.Join(db.DictamenProblema, n => n.idPaciente, m => m.idPaciente, (n, m) => new { N = n, M = m })
                .Where(w => w.N.FechaCita >= dateToday && w.N.FechaCita < dateTomorrow && w.M.EstatusEnvio == "SI")
                .Select(S => new
                {
                    S.N.Sucursal,
                    S.N.FechaCita
                }).Count();

    var mejorSucursal = (from s in db.Cita where s.FechaCita >= dateToday && s.FechaCita < dateTomorrow && s.Doctor != null select s).GroupBy(o => o.Sucursal);
    var mejorS = (from m in mejorSucursal select m).OrderByDescending(o => o.Count());

    var mejorGestor = (from s in db.Cita where s.FechaCita >= dateToday && s.FechaCita < dateTomorrow && (s.Canal != "SITIO" && s.Canal != "Call Center") select s).GroupBy(o => o.Canal);
    var mejorG = (from m in mejorGestor select m).OrderByDescending(o => o.Count());

    var mejorCapturista = (from s in db.Captura where s.FechaExpdiente >= dateToday && s.FechaExpdiente < dateTomorrow && s.EstatusCaptura == "Terminado" select s).GroupBy(o => o.Capturista);
    var mejorC = (from m in mejorCapturista select m).OrderByDescending(o => o.Count());

    var capturistas = from c in db.Usuarios where c.idRol == 7 && c.idUsuario != 13 && c.idUsuario != 25 select c.Nombre;

    var capturistasAnexa = from c in db.Usuarios where c.idRol == 9 select c.Nombre;

    int citasEfectuadas = (from c in db.Cita select c).Where(w => w.FechaCita >= dateToday && w.FechaCita < dateTomorrow && w.CC != null).Count();
    var citasCompletadas = (from c in db.Cita select c).Where(w => w.FechaCita >= dateToday && w.FechaCita < dateTomorrow && w.CC != null);
    int citasCanceladas = (from c in citasCompletadas select c).Where(w => w.Doctor == null || w.CC != null).Count();

    int efectividad = 100;

    if (citasCanceladas != 0)
    {
        efectividad = 100 - ((citasCanceladas * 100) / citasEfectuadas);
    }

    int flag = 1;
    int flag2 = 1;
    int flag3 = 1;

}

<br />

<h3 style="color:white" class="text-center">Administrador </h3>

<br />



<!-- Button trigger modal -->
<button type="button" class="btn btn-outline-warning boton-transparenteIndicador1 botonesGral col-md-4" data-toggle="modal" data-target="#citasHoy" style="color:white">
    <h4><span class="glyphicon glyphicon-list-alt"></span> &nbsp; &nbsp;Citas: <b>@citasHoyConteo</b></h4>
</button>

<!-- Modal -->
<div class="modal fade" id="citasHoy" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header" style="background-color:aquamarine">
                <h3 class="modal-title" id="exampleModalLabel"><span class="glyphicon glyphicon-list-alt"></span> &nbsp; &nbsp;Citas generadas: <b>@citasHoyConteo</b></h3>
            </div>
            <div class="modal-body">
                @{
                    foreach (var item in sucursalesLista)
                    {
                        var elemento = (from e in db.Cita where e.Sucursal == item.Nombre && e.FechaCita >= dateToday && e.FechaCita < dateTomorrow select e).Count();

                        <h4><b>@item.Nombre:</b> @elemento</h4>
                    }
                }
            </div>
        </div>
    </div>
</div>

<!-- Button trigger modal -->
<button type="button" class="btn btn-outline-warning boton-transparenteIndicador2 botonesGral col-md-4" data-toggle="modal" data-target="#episHoy" style="color:white">
    <h4><span class="glyphicon glyphicon-duplicate"></span> &nbsp; &nbsp;EPIs: <b>@episHoyConteo</b></h4>
</button>

<!-- Modal -->
<div class="modal fade" id="episHoy" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header" style="background-color:aquamarine">
                <h3 class="modal-title" id="exampleModalLabel"><span class="glyphicon glyphicon-duplicate"></span> &nbsp; &nbsp;EPIs digitalizados: <b>@episHoyConteo</b></h3>
            </div>
            <div class="modal-body">
                @{
                    foreach (var item in sucursalesLista)
                    {
                        var elemento = (from e in db.Captura where e.Sucursal == item.Nombre && e.FechaExpdiente >= dateToday && e.FechaExpdiente < dateTomorrow select e).Count();

                        <h4><b>@item.Nombre:</b> @elemento</h4>
                    }
                }
            </div>
        </div>
    </div>
</div>


<!-- Button trigger modal -->
<button type="button" class="btn btn-outline-warning boton-transparenteIndicador3 botonesGral col-md-4" data-toggle="modal" data-target="#dictamenesHoy" style="color:white">
    <h4><span class="glyphicon glyphicon-file"></span> &nbsp; &nbsp;Dictámenes: <b>@dictamenHoyConteo</b></h4>
</button>

<!-- Modal -->
<div class="modal fade" id="dictamenesHoy" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header" style="background-color:aquamarine">
                <h3 class="modal-title" id="exampleModalLabel"><span class="glyphicon glyphicon-file"></span> &nbsp; &nbsp;Dictámenes generados: <b>@dictamenHoyConteo</b></h3>
            </div>
            <div class="modal-body">
                @{
                    foreach (var item in sucursalesLista)
                    {
                        var elemento = (from e in db.Captura where e.Sucursal == item.Nombre && e.FechaExpdiente >= dateToday && e.FechaExpdiente < dateTomorrow && e.EstatusCaptura == "Terminado" select e).Count();

                        <h4><b>@item.Nombre:</b> @elemento</h4>
                    }
                }
            </div>
        </div>
    </div>
</div>


<!-- Button trigger modal -->
<button type="button" class="btn btn-outline-warning boton-transparenteIndicador4 botonesGral col-md-4" data-toggle="modal" data-target="#enProcesoHoy" style="color:white">
    <h4><span class="glyphicon glyphicon-copy"></span> &nbsp; &nbsp;Dictámenes en Proceso: <b>@enProcesoHoyConteo</b></h4>
</button>

<!-- Modal -->
<div class="modal fade" id="enProcesoHoy" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header" style="background-color:gold">
                <h3 class="modal-title" id="exampleModalLabel"><span class="glyphicon glyphicon-copy"></span> &nbsp; &nbsp;Dictámenes en Proceso: <b>@enProcesoHoyConteo</b></h3>
            </div>
            <div class="modal-body">
                @{
                    foreach (var item in sucursalesLista)
                    {
                        var elemento = (from e in db.Captura where e.Sucursal == item.Nombre && e.FechaExpdiente >= dateToday && e.FechaExpdiente < dateTomorrow && (e.EstatusCaptura == "En captura..." || e.EstatusCaptura == "No iniciado") select e).Count();

                        <h4><b>@item.Nombre:</b> @elemento</h4>
                    }
                }
            </div>
        </div>
    </div>
</div>

<!-- Button trigger modal -->
<button type="button" class="btn btn-outline-warning boton-transparenteIndicador5 botonesGral col-md-4" data-toggle="modal" data-target="#pendientesHoy" style="color:white">
    <h4><span class="glyphicon glyphicon-file"></span> &nbsp; &nbsp;Dictámenes con Incidencia: <b>@pendientesHoyConteo</b></h4>
</button>

<!-- Modal -->
<div class="modal fade" id="pendientesHoy" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header" style="background-color:crimson">
                <h3 class="modal-title" id="exampleModalLabel"><span class="glyphicon glyphicon-file"></span> &nbsp; &nbsp;Dictámenes Pendientes: <b>@pendientesHoyConteo</b></h3>
            </div>
            <div class="modal-body">
                @{
                    foreach (var item in sucursalesLista)
                    {
                        var elemento = (from e in db.Captura where e.Sucursal == item.Nombre && e.FechaExpdiente >= dateToday && e.FechaExpdiente < dateTomorrow && e.EstatusCaptura == "Pendiente" select e).Count();

                        <h4><b>@item.Nombre:</b> @elemento</h4>
                    }
                }
            </div>
        </div>
    </div>
</div>

<!-- Button trigger modal -->
<button type="button" class="btn btn-outline-warning boton-transparenteIndicador6 botonesGral col-md-4" data-toggle="modal" data-target="#entregados" style="color:white">
    <h4><span class="glyphicon glyphicon-thumbs-up"></span> &nbsp; &nbsp;Dictámenes Entregados: <b>@entregadosConteo</b></h4>
</button>

<!-- Modal -->
<div class="modal fade" id="entregados" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header" style="background-color:aquamarine">
                <h3 class="modal-title" id="exampleModalLabel"><span class="glyphicon glyphicon-thumbs-up"></span> &nbsp; &nbsp;Dictámenes Entregados: <b>@entregadosConteo</b></h3>
            </div>
            <div class="modal-body">
                @{
                    foreach (var item in sucursalesLista)
                    {
                        var elemento = (from e in db.Cita where e.Sucursal == item.Nombre && e.FechaCita >= dateToday && e.FechaCita < dateTomorrow && (e.Entregado == "SI") select e).Count();

                        <h4><b>@item.Nombre:</b> @elemento</h4>
                    }
                }
            </div>
        </div>
    </div>
</div>

<!-- Button trigger modal -->
<button type="button" class="btn btn-outline-warning boton-transparenteIndicador7 botonesGral col-md-4" data-toggle="modal" data-target="#enviados" style="color:white">
    <h4><span class="glyphicon glyphicon-send"></span> &nbsp; &nbsp;Dictámenes Enviados: <b>@entregadosConteo</b></h4>
</button>

<!-- Modal -->
<div class="modal fade" id="enviados" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header" style="background-color:aquamarine">
                <h3 class="modal-title" id="exampleModalLabel"><span class="glyphicon glyphicon-send"></span> &nbsp; &nbsp;Dictámenes Enviados: <b>@enviadosCount</b></h3>
            </div>
            <div class="modal-body">
                @{
                    foreach (var item in sucursalesLista)
                    {
                        var elemento = (from e in enviados where e.Sucursal == item.Nombre && e.FechaCita >= dateToday && e.FechaCita < dateTomorrow && e.EstatusEnvio == "SI" select e).Count();

                        <h4><b>@item.Nombre:</b> @elemento</h4>
                    }
                }
            </div>
        </div>
    </div>
</div>


<!-- Button trigger modal -->
<button type="button" class="btn btn-outline-warning boton-transparenteIndicador1 botonesGral col-md-4" data-toggle="modal" data-target="#exampleModal5" style="color:white">
    <h4><span class="glyphicon glyphicon-user"></span> &nbsp; &nbsp;Dictámenes por Capturista</h4>
</button>

<!-- Modal -->
<div class="modal fade" id="exampleModal5" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header" style="background-color:aquamarine">
                <h3 class="modal-title" id="exampleModalLabel"><span class="glyphicon glyphicon-user"></span> &nbsp; &nbsp;Dictámenes por Capturista</h3>
            </div>
            <div class="modal-body">
                @{
                    foreach (var item in capturistas)
                    {
                        var elemento = (from v in db.Captura where v.EstatusCaptura == "Terminado" && v.FechaExpdiente >= dateToday && v.FechaExpdiente < dateTomorrow && v.Capturista == item select v).Count();
                        var sumaMinutos = ((from v in db.Captura where v.EstatusCaptura == "Terminado" && v.FechaExpdiente >= dateToday && v.FechaExpdiente < dateTomorrow && v.Capturista == item select v.Duracion).Sum()) / elemento;
                        if (sumaMinutos == null)
                        {
                            sumaMinutos = 0;
                        }
                        <h4><b>@item:</b> @elemento <b class="text-primary h6">(@sumaMinutos mins/Dictamen)</b></h4>
                    }
                    <h4>----------------------</h4>
                    foreach (var item in capturistasAnexa)
                    {
                        var elemento = (from v in db.Captura where v.EstatusCaptura == "Terminado" && v.FechaExpdiente >= dateToday && v.FechaExpdiente < dateTomorrow && v.Capturista == item select v).Count();
                        <h4><b>@item (Anexa):</b> @elemento</h4>
                    }
                }
            </div>
        </div>
    </div>
</div>


<!-- Button trigger modal -->
<button type="button" class="btn btn-outline-warning boton-transparenteIndicador2 botonesGral col-md-4" data-toggle="modal" data-target="#efectividad" style="color:white">
    <h4><span class="glyphicon glyphicon-stats"></span> &nbsp; &nbsp;Efectividad ANEXA: @efectividad%</h4>
</button>

<!-- Modal -->
<div class="modal fade" id="efectividad" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header" style="background-color:aquamarine">
                <h3 class="modal-title" id="exampleModalLabel"><span class="glyphicon glyphicon-stats"></span> &nbsp; &nbsp;Efectividad ANEXA</h3>
            </div>
            <div class="modal-body">

            </div>
        </div>
    </div>
</div>


<br />
<br />
<br />



<div class="tablaScroll3" style="width:45%; display:inline-block; min-width:340px; margin:2%">
    <br />
    <h3 style="color:white">Top Sucursales</h3>
    <table class="table tablas table-responsive" style="color: #2F2D6B; width: 100%; min-width: 400px">
        <thead>
            <tr class="bg-primary">
                <th>                </th>
                <th>
                    <h4>Sucursal</h4>
                </th>
                <th>
                    <h4>EPIs</h4>
                </th>
            </tr>
        </thead>


        @foreach (var item in mejorS)
        {
            <tr>
                <td>@flag</td>
                <td>
                    <b>@item.Key</b>
                </td>
                <td>
                    @item.Count()
                </td>
            </tr>
            flag++;
        }

    </table>
</div>

<div class="tablaScroll3" style="width:45%; display:inline-block; min-width:340px; margin:2%">
    <br />
    <h3 style="color:white">Top Gestores</h3>
    <table class="table tablas table-responsive" style="color: #2F2D6B; width: 100%; min-width: 400px">
        <thead>
            <tr class="bg-primary">
                <th>                </th>
                <th>
                    <h4>Gestor</h4>
                </th>
                <th>
                    <h4>EPIs</h4>
                </th>
            </tr>
        </thead>


        @foreach (var item in mejorG)
        {
            <tr>
                <td>@flag2</td>
                <td>
                    <b>@item.Key</b>
                </td>
                <td>
                    @item.Count()
                </td>
            </tr>
            flag2++;
        }

    </table>
</div>

<div class="tablaScroll3" style="width:45%; display:inline-block; min-width:340px; margin:2%">
    <br />
    <h3 style="color:white">Top Capturistas</h3>
    <table class="table tablas table-responsive" style="color: #2F2D6B; width: 100%; min-width: 400px">
        <thead>
            <tr class="bg-primary">
                <th>                </th>
                <th>
                    <h4>Capturista</h4>
                </th>
                <th>
                    <h4>EPIs</h4>
                </th>
                <th>
                    <h4>Promedio/EPI</h4>
                </th>
            </tr>
        </thead>


        @foreach (var item in mejorC)
        {
            <tr>
                <td>@flag3</td>
                <td>
                    <b>@item.Key</b>
                </td>
                <td>
                    @item.Count()
                </td>
                <td>
                    @{
                        var elemento = (from v in db.Captura where v.EstatusCaptura == "Terminado" && v.FechaExpdiente >= dateToday && v.FechaExpdiente < dateTomorrow && v.Capturista == item.Key select v).Count();
                        var sumaMinutos = ((from v in db.Captura where v.EstatusCaptura == "Terminado" && v.FechaExpdiente >= dateToday && v.FechaExpdiente < dateTomorrow && v.Capturista == item.Key select v.Duracion).Sum()) / elemento;
                        if (sumaMinutos == null)
                        {
                            sumaMinutos = 0;
                        }
                        <b>@sumaMinutos minutos</b>
                    }
                </td>
            </tr>
                            flag3++;
                        }

    </table>
</div>