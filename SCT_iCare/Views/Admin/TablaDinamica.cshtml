
@{
    ViewBag.Title = "TablaDinamica";

    GMIEntities db = new GMIEntities();

    var sucursales = db.Sucursales.Where(w => w.Nombre != "CULIACÁN" && w.Nombre != "MIXCOAC").OrderBy(o => o.Nombre);

    int flag = 1;

    int diaCorrienteHeader = 1;
    int diaCorrienteRow = 1;
    int diaCorrienteFooter = 1;

    int diaMes = DateTime.Today.Day;

    int episTotal = 0;
    int pausaTotal = 0;
    int dictamenTotal = 0;


    int episTotalTOTAL = 0;
    int pausaTotalTOTAL = 0;
    int dictamenTotalTOTAL = 0;

    int episTotalFooter = 0;
    int pausaTotalFooter = 0;
    int dictamenTotalFooter = 0;
}
<br />
<h2 style="color:white">Sucursales</h2>
<br />

<form class="form-inline" method="post" enctype="multipart/form-data" action="@Url.Content("~/Admin/TablaDinamica")">
    <div>

        <select name="gestor" style="font-size:2vh" class="form-control">
            <option>Seleccionar</option>
            <option value="Diarias">METAS DIARIAS</option>
            <option value="Semanales">METAS SEMANALES</option>
            <option value="Sucursales">SUCURSALES</option>
            <option value="CallCenter">CALL CENTER</option>
            <option value="Gestores">GESTORES</option>
            <option value="Alternativos">ALTERNATIVOS</option>
        </select>
        <input type="month" class="form-control" />
        <input type="submit" class="btn btn-info" value="Enviar" />
    </div>
</form>


<div class="tablaScroll">
    <br />
    <table class="table  table-bordered table-hover tablas" style="color: #2F2D6B">
        <thead>
            <tr @*class="bg-primary" style="border-top-color: black; font-size:smaller"*@>
                <th class="bg-primary" style="border-top-color: dimgray; border-top-width:1.1px; position: sticky; left: 0">
                    <b>SUCURSAL</b>
                </th>
                <th class="bg-primary" colspan="3" style="border-top-color:  dimgray; border-top-width:1.1px; position: sticky; left: 106px">
                    <b>TOTAL</b>
                </th>

                @{

                    while (diaCorrienteHeader <= diaMes)
                    {
                        DateTime fecha = new DateTime(DateTime.Today.Year, DateTime.Today.Month, diaCorrienteHeader);
                        string fechaString = fecha.ToString("dd-MM-yy");
                        <td class="bg-primary" colspan="3" style="text-align:center">
                            @fechaString
                        </td>
                        diaCorrienteHeader++;

                    }

                    diaCorrienteHeader = 1;
                }
            </tr>
        </thead>

        <tr @*class="bg-info"*@>
            <th class="bg-info" style="border-top-color: black; font-size: smaller; position: sticky; left: 0; border-right-width: 1.1px; border-right-color: dimgray"></th>

            <th class="bg-info" style="text-align: center; font-size: xx-small; position: sticky; left: 106px; border-left-width: 1.1px; border-left-color: dimgray">
                <b>EPIS</b>
            </th>
            <th class="bg-info" style="text-align: center; font-size: xx-small; position: sticky; left: 148px">
                <b>REALIZADOS</b>
            </th>
            <th class="bg-info" style="text-align: center; font-size: xx-small; position: sticky; left: 217px; border-right-width: 1.1px; border-right-color: dimgray">
                <b>PAUSADO</b>
            </th>

            @{


                while (diaCorrienteHeader <= diaMes)
                {
                    <td class="bg-info" style="border-left-color: dimgray; border-left-width: 1.1px; text-align: center; font-size: xx-small" id="hidden">
                        <b>EPIS</b>
                    </td>
                    <td class="bg-info" style="text-align: center; font-size: xx-small" id="hidden">
                        <b>REALIZADOS</b>
                    </td>
                    <td class="bg-info" style="border-right-color: dimgray; border-right-width: 1.1px; text-align: center; font-size: xx-small" id="hidden">
                        <b>PAUSADO</b>
                    </td>
                    diaCorrienteHeader++;
                }
            }

        </tr>


        @foreach (var item in sucursales)
        {

            <tr @*style="border-top-color: black; border-top-width:2px"*@>

                <th class="bg-info" style="border-top-color:  dimgray; border-top-width:1.1px; position: sticky; left: 0">
                    <b>@item.Nombre</b>
                </th>

                @{


                    while (diaCorrienteRow <= diaMes)
                    {
                        DateTime fecha = new DateTime(DateTime.Today.Year, DateTime.Today.Month, diaCorrienteRow);
                        DateTime fecha1 = new DateTime(DateTime.Today.Year, DateTime.Today.Month, diaCorrienteRow).AddDays(1);


                        int epis = (from i in db.Captura where i.Sucursal == item.Nombre && i.FechaExpdiente >= fecha && i.FechaExpdiente < fecha1 select i).Count();
                        int pausa = (from i in db.Captura where i.Sucursal == item.Nombre && i.FechaExpdiente >= fecha && i.FechaExpdiente < fecha1 && i.EstatusCaptura == "Pausado" select i).Count();
                        int dictamen = (from i in db.Captura where i.Sucursal == item.Nombre && i.FechaExpdiente >= fecha && i.FechaExpdiente < fecha1 && i.EstatusCaptura == "Terminado" select i).Count();

                        episTotal += epis;
                        pausaTotal += pausa;
                        dictamenTotal += dictamen;

                        diaCorrienteRow++;

                    }

                    episTotalTOTAL += episTotal;
                    pausaTotalTOTAL += pausaTotal;
                    dictamenTotalTOTAL += dictamenTotal;

                    diaCorrienteRow = 1;
                }

                <td style="background-color: whitesmoke; border-top-color: dimgray; border-top-width: 1.1px; text-align: center; border-left-color: dimgray; border-left-width: 1.1px; position: sticky; left: 106px">
                    <b>@episTotal</b>
                </td>
                <td style="background-color: whitesmoke; border-top-color: dimgray; border-top-width: 1.1px; text-align: center; position: sticky; left: 148px">
                    <b>@dictamenTotal</b>
                </td>
                <td style="background-color: whitesmoke; border-top-color: dimgray; border-top-width: 1.1px; text-align: center; position: sticky; left: 217px">
                    <b>@pausaTotal</b>
                </td>

                @{


                    while (diaCorrienteRow <= diaMes)
                    {
                        DateTime fecha = new DateTime(DateTime.Today.Year, DateTime.Today.Month, diaCorrienteRow);
                        DateTime fecha1 = new DateTime(DateTime.Today.Year, DateTime.Today.Month, diaCorrienteRow).AddDays(1);


                        int epis = (from i in db.Captura where i.Sucursal == item.Nombre && i.FechaExpdiente >= fecha && i.FechaExpdiente < fecha1 select i).Count();
                        int pausa = (from i in db.Captura where i.Sucursal == item.Nombre && i.FechaExpdiente >= fecha && i.FechaExpdiente < fecha1 && i.EstatusCaptura == "Pausado" select i).Count();
                        int dictamen = (from i in db.Captura where i.Sucursal == item.Nombre && i.FechaExpdiente >= fecha && i.FechaExpdiente < fecha1 && i.EstatusCaptura == "Terminado" select i).Count();

                        episTotal += epis;
                        pausaTotal += pausa;
                        dictamenTotal += dictamen;

                        <td style="border-left-color:  dimgray; border-left-width:1.2px;border-top-color:  dimgray; border-top-width:1.1px; text-align: center" id="hidden">
                            @epis
                        </td>
                        <td style="border-top-color:  dimgray; border-top-width:1.1px; text-align: center" id="hidden">
                            @dictamen
                        </td>
                        <td style="border-right-color:  dimgray; border-right-width:1.2px;border-top-color:  dimgray; border-top-width:1.1px; text-align: center" id="hidden">
                            @pausa
                        </td>
                        diaCorrienteRow++;

                    }

                    diaCorrienteRow = 1;
                }

                @{
                    episTotal = 0;
                    pausaTotal = 0;
                    dictamenTotal = 0;
                }

            </tr>

            flag += 1;

        }

        <tr>
            <th class="bg-info" style="border-top-color: dimgray; border-top-width: 1.1px; position: sticky; left: 0">
                <b>TOTALES</b>
            </th>
            <td style="background-color: whitesmoke; border-top-color: dimgray; border-top-width: 1.1px; text-align: center; border-left-color: dimgray; border-left-width: 1.2px; position: sticky; left: 106px">
                <b>@episTotalTOTAL</b>
            </td>
            <td style="background-color: whitesmoke; border-top-color: dimgray; border-top-width: 1.1px; text-align: center; position: sticky; left: 148px">
                <b>@dictamenTotalTOTAL</b>
            </td>
            <td style="background-color: whitesmoke; border-top-color: dimgray; border-top-width: 1.1px; text-align: center; position: sticky; left: 217px">
                <b>@pausaTotalTOTAL</b>
            </td>


            @{

                while (diaCorrienteFooter <= diaMes)
                {
                    DateTime fecha = new DateTime(DateTime.Today.Year, DateTime.Today.Month, diaCorrienteFooter);
                    DateTime fecha1 = new DateTime(DateTime.Today.Year, DateTime.Today.Month, diaCorrienteFooter).AddDays(1);

                    foreach (var sucursal in sucursales)
                    {


                        int epis = (from i in db.Captura where i.Sucursal == sucursal.Nombre && i.FechaExpdiente >= fecha && i.FechaExpdiente < fecha1 select i).Count();
                        int pausa = (from i in db.Captura where i.Sucursal == sucursal.Nombre && i.FechaExpdiente >= fecha && i.FechaExpdiente < fecha1 && i.EstatusCaptura == "Pausado" select i).Count();
                        int dictamen = (from i in db.Captura where i.Sucursal == sucursal.Nombre && i.FechaExpdiente >= fecha && i.FechaExpdiente < fecha1 && i.EstatusCaptura == "Terminado" select i).Count();

                        episTotal += epis;
                        pausaTotal += pausa;
                        dictamenTotal += dictamen;

                        episTotalFooter += episTotal;
                        pausaTotalFooter += pausaTotal;
                        dictamenTotalFooter += dictamenTotal;

                        episTotal = 0;
                        pausaTotal = 0;
                        dictamenTotal = 0;
                    }



                    <td style="border-left-color:  dimgray; border-left-width:1.2px;border-top-color:  dimgray; border-top-width:1.1px; text-align: center; background-color: whitesmoke;" id="hidden">
                        @episTotalFooter
                    </td>
                    <td style="border-top-color:  dimgray; border-top-width:1.1px; text-align: center; background-color: whitesmoke;" id="hidden">
                        @dictamenTotalFooter
                    </td>
                    <td style="border-right-color:  dimgray; border-right-width:1.2px;border-top-color:  dimgray; border-top-width:1.1px; text-align: center; background-color: whitesmoke;" id="hidden">
                        @pausaTotalFooter
                    </td>

                    episTotalFooter = 0;
                    pausaTotalFooter = 0;
                    dictamenTotalFooter = 0;

                    diaCorrienteFooter++;

                }

                episTotal = 0;
                pausaTotal = 0;
                dictamenTotal = 0;

                flag += 1;

            }

        </tr>

    </table>
</div>



