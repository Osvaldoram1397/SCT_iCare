@model IEnumerable<SCT_iCare.Paciente>

@{
    ViewBag.Title = "Index";

    var oUser = (Usuarios)HttpContext.Current.Session["User"];

    GMIEntities db = new GMIEntities();

    var Recepcion = new int?();
    var Hospital = "";
    var idHospital = 0;
    string Sucursal = null;
    int idUser = 3;
    string nombreUsuario = null;
    string fila = "";
    int registros;

    int flag = 1; //contador de la tabla

    DateTime start = DateTime.Now;
    DateTime finish = DateTime.Now.AddDays(1);

    int year = start.Year;
    int month = start.Month;
    int day = start.Day;

    int year1 = finish.Year;
    int month1 = finish.Month;
    int day1 = finish.Day;

    int tomorrorDay = day + 1;
    DateTime thisDate = new DateTime(year, month, day);
    DateTime tomorrowDate = new DateTime(year1, month1, day1);

    var modelo = db.Paciente.Join(db.Cita, n => n.Folio, m => m.Folio, (n, m) => new { N = n, M = m }).Where(s => s.M.Sucursal == Sucursal && s.M.FechaReferencia >= thisDate && s.M.FechaReferencia < tomorrowDate)@*.OrderByDescending(o => new { o.M.TipoTramite,  }).OrderBy(r => r.M.EstatusPago)*@;


if (oUser != null)
{
idUser = oUser.idUsuario;
nombreUsuario = oUser.Nombre;


Hospital = "GENERAL";
Sucursal = Hospital.ToString();

modelo = db.Paciente.Join(db.Cita, n => n.Folio, m => m.Folio, (n, m) => new { N = n, M = m }).Where(s => s.M.FechaReferencia >= thisDate && s.M.FechaReferencia < tomorrowDate && s.M.CC == oUser.Nombre)@*.OrderByDescending(o => new { o.M.TipoTramite,  }).OrderBy(r => r.M.EstatusPago)*@;

registros = db.Paciente.Join(db.Cita, n => n.Folio, m => m.Folio, (n, m) => new { N = n, M = m }).Where(s => s.M.FechaReferencia >= thisDate && s.M.FechaReferencia < tomorrowDate && s.M.CC == oUser.Nombre).Count();
}

}

<br />
<br />
<h3 style="color:white" class="text-center">Call Center</h3>
@*<button type="button" class="btn btn-warning" data-toggle="modal" data-target="#exampleModal2"><span class="glyphicon glyphicon-plus"></span> Crear Referecia de Pago</button>*@
<div class="form-inline">
    @*<button type="button" class="btn btn-success" data-toggle="modal" data-target="#exampleModal"><span class="glyphicon glyphicon-plus"></span> Cita con Pago</button>*@
    <button type="button" class="btn btn-warning" data-toggle="modal" data-target="#exampleModal2"><span class="glyphicon glyphicon-plus"></span> Crear Referecia de Pago</button>
    <a href=@Url.Action("Index", "ControlDictamen")><button style="color:white" type="button" class="btn btn-info"><span class="glyphicon glyphicon-th-list"></span> &nbsp; &nbsp;Dictámenes</button></a>

    <div class="input-group pull-right">
        <input type="text" class="form-control" id="buscador" name="dato" placeholder="Paciente o Expediente">
        <span class="input-group-btn">
            si
            <button class="btn btn-info buscar" id="buscar" type="button"><span class="glyphicon glyphicon-search"></span></button>
        </span>
    </div>
</div>
<br />

@section scripts{
    <script>
    $(function () {
        $(".buscar").click(function () {
            var url = "@Url.Action("Buscar", "Recepcion")";
            var dato = $("#buscador").val();
            var data = { dato: dato };

            $.post(url, data).done(function (data1) {
                console.log(data);
                let miResultado = "";
                if ($.isEmptyObject(data)) {
                    miResultado = "<h3>No se encontraron registros!!</h3>"
                }
                else {
                    miResultado += "<h4 class=\"text-danger\">Se encontraron <b>" + data.length + "</b> registros:</h4><hr/>"
                    for (let i = 0; i < data.length; i++) {

                        if (data[i].NoExpediente == null) {
                            miResultado +=
                            "<h5><b><mark style=\"background-color: #41F51A; padding:5px; border-radius: 10px\">ID: " + data[i].idPaciente + "</mark></b></h5>" +
                            "<p>Nombre: <b>" + data[i].Nombre + "</b></p>" +
                            "<p>Teléfono: <b>" + data[i].Telefono + "</b></p>" +
                            "<p>Email: <b>" + data[i].Email + "</b></p>" +
                            "<p>Folio: <b>" + data[i].Folio + "</b></p>" +
                            "<p>CURP: <b>" + data[i].CURP + "</b></p>" +
                            "<hr/>"
                        }
                        else
                        {
                            miResultado +=
                            "<h5><b><mark style=\"background-color: #41F51A; padding:5px; border-radius: 10px\">ID: " + data[i].idPaciente + "</mark></b></h5>" +
                            "<p>Nombre: <b>" + data[i].Nombre + "</b></p>" +
                            "<p>Teléfono: <b>" + data[i].Telefono + "</b></p>" +
                            "<p>Email: <b>" + data[i].Email + "</b></p>" +
                            "<p>Folio: <b>" + data[i].Folio + "</b></p>" +
                            "<p>CURP: <b>" + data[i].CURP + "</b></p>" +
                            "<p>Tipo de Pago: <b>" + data[i].TipoPago + "</b></p>" +
                            "<p>Fecha Cita: <b>" + data[i].FechaCita + "</b></p>" +
                            "<p>No. Orden: <b>" + data[i].NoOrden + "</b></p>" +
                            "<p>Estatus Pago: <b>" + data[i].EstatusPago + "</b></p>" +
                            "<p>Tipo Licencia : <b>" + data[i].TipoLicencia + "</b></p>" +
                            "<p>No. Expediente: <b>" + data[i].NoExpediente + "</b></p>" +
                            "<p>Referencia: <b>" + data[i].Referencia + "</b></p>" +
                            "<p>Fecha Referencia: <b>" + data[i].FechaReferencia + "</b></p>" +
                            "<p>Sucursal: <b>" + data[i].Sucursal + "</b></p>" +
                            "<p>Doctor: <b>" + data[i].Doctor + "</b></p>" +
                            "<p>Tipo Trámite: <b>" + data[i].TipoTramite + "</b></p>" +
                            "<hr/>"
                        }
                    }
                }

                $('#exampleModal5').modal('show');
                document.getElementById("cuerpo").innerHTML = miResultado;

            }).fail().always(function () {

            });
        });
    });
    </script>

    @*<script src="~/Scripts/jquery.unobtrusive-ajax.js"></script>
        <script src="~/Scripts/jquery-ui-1.12.1.js"></script>

        <script>
            $(function () {
                $("#buscador").autocomplete({
                    source: "/CallCenter/Buscar"
                });
            });
        </script>



        <link href="https://unpkg.com/bootstrap-table@1.18.3/dist/bootstrap-table.min.css" rel="stylesheet">

        <script src="https://unpkg.com/bootstrap-table@1.18.3/dist/bootstrap-table.min.js"></script>

        <table id="table" class="tablas"
               data-toggle="table"
               data-url="/CallCenter/BuscarBT">
            <thead>
                <tr>
                    <th data-field="Telefono">ID</th>
                    <th data-field="Nombre">Item Name</th>
                    <th data-field="Email">Item Price</th>
                </tr>
            </thead>
        </table>*@


    @*<link href="https://unpkg.com/bootstrap-table@1.18.3/dist/bootstrap-table.min.css" rel="stylesheet">

    <script src="https://unpkg.com/tableexport.jquery.plugin/tableExport.min.js"></script>
    <script src="https://unpkg.com/bootstrap-table@1.18.3/dist/bootstrap-table.min.js"></script>
    <script src="https://unpkg.com/bootstrap-table@1.18.3/dist/bootstrap-table-locale-all.min.js"></script>
    <script src="https://unpkg.com/bootstrap-table@1.18.3/dist/extensions/export/bootstrap-table-export.min.js"></script>

    <style>
        .select,
        #locale {
            width: 100%;
        }

        .like {
            margin-right: 10px;
        }
    </style>

    <div class="select">
        <select class="form-control" id="locale">
            <option value="af-ZA">af-ZA</option>
            <option value="ar-SA">ar-SA</option>
            <option value="ca-ES">ca-ES</option>
            <option value="cs-CZ">cs-CZ</option>
            <option value="da-DK">da-DK</option>
            <option value="de-DE">de-DE</option>
            <option value="el-GR">el-GR</option>
            <option value="en-US" selected>en-US</option>
            <option value="es-AR">es-AR</option>
            <option value="es-CL">es-CL</option>
            <option value="es-CR">es-CR</option>
            <option value="es-ES">es-ES</option>
            <option value="es-MX">es-MX</option>
            <option value="es-NI">es-NI</option>
            <option value="es-SP">es-SP</option>
            <option value="et-EE">et-EE</option>
            <option value="eu-EU">eu-EU</option>
            <option value="fa-IR">fa-IR</option>
            <option value="fi-FI">fi-FI</option>
            <option value="fr-BE">fr-BE</option>
            <option value="fr-FR">fr-FR</option>
            <option value="he-IL">he-IL</option>
            <option value="hr-HR">hr-HR</option>
            <option value="hu-HU">hu-HU</option>
            <option value="id-ID">id-ID</option>
            <option value="it-IT">it-IT</option>
            <option value="ja-JP">ja-JP</option>
            <option value="ka-GE">ka-GE</option>
            <option value="ko-KR">ko-KR</option>
            <option value="ms-MY">ms-MY</option>
            <option value="nb-NO">nb-NO</option>
            <option value="nl-NL">nl-NL</option>
            <option value="pl-PL">pl-PL</option>
            <option value="pt-BR">pt-BR</option>
            <option value="pt-PT">pt-PT</option>
            <option value="ro-RO">ro-RO</option>
            <option value="ru-RU">ru-RU</option>
            <option value="sk-SK">sk-SK</option>
            <option value="sv-SE">sv-SE</option>
            <option value="th-TH">th-TH</option>
            <option value="tr-TR">tr-TR</option>
            <option value="uk-UA">uk-UA</option>
            <option value="ur-PK">ur-PK</option>
            <option value="uz-Latn-UZ">uz-Latn-UZ</option>
            <option value="vi-VN">vi-VN</option>
            <option value="zh-CN">zh-CN</option>
            <option value="zh-TW">zh-TW</option>
        </select>
    </div>

    <div id="toolbar">
        <button id="remove" class="btn btn-danger" disabled>
            <i class="fa fa-trash"></i> Delete
        </button>
    </div>
    <div class="container">
        <table id="table" class="tablas"
               data-toolbar="#toolbar"
               data-search="true"
               data-show-refresh="true"
               data-show-toggle="true"
               data-show-columns="true"
               data-show-columns-toggle-all="true"
               data-detail-view="true"
               data-show-export="true"
               data-click-to-select="true"
               data-detail-formatter="detailFormatter"
               data-minimum-count-columns="2"
               data-pagination="true"
               data-id-field="id"
               data-page-list="[10, 25, 50, 100, all]"
               data-show-footer="true"
               data-side-pagination="server"
               data-url="/CallCenter/BuscarBT"
               data-response-handler="responseHandler">
        </table>
    </div>


    <script>
        var $table = $('#table')
        var $remove = $('#remove')
        var selections = []

        function getIdSelections() {
            return $.map($table.bootstrapTable('getSelections'), function (row) {
                return row.id
            })
        }

        function responseHandler(res) {
            $.each(res.rows, function (i, row) {
                row.state = $.inArray(row.id, selections) !== -1
            })
            return res
        }

        function detailFormatter(index, row) {
            var html = []
            $.each(row, function (key, value) {
                html.push('<p><b>' + key + ':</b> ' + value + '</p>')
            })
            return html.join('')
        }

        function operateFormatter(value, row, index) {
            return [
                '<a class="like" href="javascript:void(0)" title="Like">',
                '<i class="fa fa-heart"></i>',
                '</a>  ',
                '<a class="remove" href="javascript:void(0)" title="Remove">',
                '<i class="fa fa-trash"></i>',
                '</a>'
            ].join('')
        }

        window.operateEvents = {
            'click .like': function (e, value, row, index) {
                alert('You click like action, row: ' + JSON.stringify(row))
            },
            'click .remove': function (e, value, row, index) {
                $table.bootstrapTable('remove', {
                    field: 'id',
                    values: [row.id]
                })
            }
        }

        function totalTextFormatter(data) {
            return 'Total'
        }

        function totalNameFormatter(data) {
            return data.length
        }

        function totalPriceFormatter(data) {
            var field = this.field
            return '$' + data.map(function (row) {
                return +row[field].substring(1)
            }).reduce(function (sum, i) {
                return sum + i
            }, 0)
        }

        function initTable() {
            $table.bootstrapTable('destroy').bootstrapTable({
                url: '/CallCenter/BuscarBT',
                height: 550,
                locale: $('#locale').val(),
                columns: [
                    [{
                        field: 'Nombre',
                        title: 'Item Name',
                        sortable: true,
                        footerFormatter: totalNameFormatter,
                        align: 'center'
                    }, {
                        field: 'Email',
                        title: 'Item Price',
                        sortable: true,
                        align: 'center',
                        footerFormatter: totalPriceFormatter
                    }]
                ]
            })
            $table.on('check.bs.table uncheck.bs.table ' +
                'check-all.bs.table uncheck-all.bs.table',
                function () {
                    $remove.prop('disabled', !$table.bootstrapTable('getSelections').length)

                    // save your data, here just save the current page
                    selections = getIdSelections()
                    // push or splice the selections if you want to save all data selections
                })
            $table.on('all.bs.table', function (e, name, args) {
                console.log(name, args)
            })
            $remove.click(function () {
                var ids = getIdSelections()
                $table.bootstrapTable('remove', {
                    field: 'id',
                    values: ids
                })
                $remove.prop('disabled', true)
            })
        }

        $(function () {
            initTable()

            $('#locale').change(initTable)
        })
    </script>*@


}

<div class="modal fade" id="exampleModal5" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title text-primary" id="exampleModalLabel"><b>Resultado de la búsqueda:</b></h3>
            </div>
            <div class="modal-body" id="cuerpo">

            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
            </div>
        </div>

    </div>
</div>


<div class="modal fade" id="exampleModal2" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title text-primary" id="exampleModalLabel"><b>Generar referencia de pago</b></h3>
            </div>
            <div class="modal-body">
                <form method="post" enctype="multipart/form-data" action="@Url.Content("~/CallCenter/Orden")">
                    @Html.AntiForgeryToken()
                    <div class="form-inline">
                        <label for="recipient-name" class="col-form-label">Cantidad de EPIs requeridos:</label>
                    </div>
                    <div class="form-inline">
                        <span class="">
                            <button class="btn btn-info" id="menos1" type="button"><b><span class="glyphicon glyphicon-minus"></span></b></button>
                        </span>
                        <input style="display:inline-block" type="number" class="form-control" id="contador1" min="1" name="cantidad" placeholder="Ingresa una cantidad" required>
                        <span class="">
                            <button class="btn btn-info" id="mas1" type="button"><b><span class="glyphicon glyphicon-plus"></span></b></button>
                        </span>
                        <br />
                        <br />
                    </div>
                    <input type="hidden" class="form-control" id="usuario" name="usuario" value="@oUser.Nombre">
                    <div class="form-group">
                        <label for="recipient-name" class="col-form-label">Nombre del Paciente (o Gestor):</label>
                        <input type="text" class="form-control" id="nombre" name="nombre" required>
                    </div>
                    <div class="form-group">
                        <label for="recipient-name" class="col-form-label">Teléfono:</label>
                        <input type="tel" class="form-control" pattern="[0-9]{10}" title="El formato de teléfono debe contener 10 números" id="telefono" name="telefono" required>
                    </div>
                    <div class="form-group">
                        <label for="recipient-name" class="col-form-label">Email:</label>
                        <input type="email" class="form-control" id="email" name="email" required>
                    </div>

                    <div class="form-group">
                        <label for="recipient-name" class="col-form-label">Fecha de Cita:</label>
                        <input type="date" class="form-control" id="fecha" name="fecha" required>
                    </div>
                    <div class="form-group" style="width:60%; min-width:320px">
                        <label for="recipient-name" class="col-form-label">Sucursal:</label>
                        <select name="sucursal" style="width:100%; min-height:5vh; min-width:99%; font-size:2vh" class="form-select">
                            @{
                                var sucursalesOption = from s in db.Sucursales select s.Nombre;
                                foreach (var opcion in sucursalesOption)
                                {
                                    <option value="@opcion">@opcion</option>
                                }
                            }
                        </select>
                    </div>
                    <div class="form-group" style="width:60%; min-width:320px">
                        <label for="recipient-name" class="col-form-label">Tipo de Licencia:</label>
                        <select name="tipoL" style="width:100%; min-height:5vh; min-width:99%; font-size:2vh" class="form-select">
                            <option value="AUTOTRANSPORTE">AUTOTRANSPORTE</option>
                            <option value="MARITIMO">MARITIMO</option>
                            <option value="AEREO">AEREO</option>
                            <option value="FERROVIARIO">FERROVIARIO</option>
                        </select>
                    </div>

</div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
                <input type="submit" value="Enviar" class="btn btn-primary" />
            </div></form>
        </div>
    </div>
</div>

<script type="text/javascript">
    var sumar1 = document.getElementById("mas1");
    var restar1 = document.getElementById("menos1");
    var contador1 = document.getElementById("contador1");
    var importe1 = document.getElementById("importe1");
    var valorBase1 = 5.20;
    var prevValue1;

    function calcular1() {
        var value1 = contador1.value;
        var isValid1 = /^[1-9][0-9]*$/.test(value1);

        if (!isValid1) {
            contador1.value = prevValue1;
        } else {
            prevValue1 = value;
        }

        importe1.value = Number1.parseFloat(contador1.value * valorBase1).toFixed(2);
    }

    sumar1.onclick = function () {
        contador1.value = Number(contador1.value) + 1;
        calcular1();
    };

    restar1.onclick = function () {
        contador1.value = Number(contador1.value) - 1;
        calcular1();
    };

    contador1.onchange = function () {
        calcular1();
    };

    contador1.onkeyup = function () {
        if (contador1.value === "") {
            return;
        }
        calcular1();
    };

    calcular1();
</script>

@if (modelo.FirstOrDefault() == null)
{
    <h1 style="color:white">No tienes Referencias de Pago el día de hoy!</h1>
}
else
{
    <div class="tablaScroll">
        <table class="table tablas" style="color: #2F2D6B">
            <tr style="background-color:#62E3C9">
                <th>
                </th>

                <th>
                    Nombre
                </th>

                <th>
                    Email
                </th>
                <th>
                    Teléfono
                </th>
                <th>
                    Referencia
                </th>
                <th>
                    Sucursal
                </th>
                <th>
                    Fecha Cita
                </th>
                <th></th>
            </tr>

            @foreach (var item in modelo)
            {


                <tr>
                    <td>
                        @flag
                    </td>

                    <td>
                        <b>@Html.DisplayFor(modelItem => item.N.Nombre)</b>
                    </td>

                    <td>
                        @Html.DisplayFor(modelItem => item.N.Email)
                    </td>

                    @*<td>
                            @Html.DisplayFor(modelItem => item.N.Telefono)
                        </td>
                        <td>
                            @Html.DisplayFor(modelItem => item.N.Email)
                        </td>*@
                    <td>
                        @Html.DisplayFor(modelItem => item.N.Telefono)
                    </td>
                    <td>
                        <b>@Html.DisplayFor(modelItem => item.M.Referencia)</b>
                    </td>
                    <td>
                        <b>@Html.DisplayFor(modelItem => item.M.Sucursal)</b>
                    </td>
                    <td>
                        @Html.DisplayFor(modelItem => item.M.FechaCita)
                    </td>
                    <td>
                        <div class="btn-group">

                            <button type="button" class="btn btn-info dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                Acciones <span class="glyphicon glyphicon-triangle-bottom"></span>
                            </button>



                            <div class="dropdown-menu" style="padding:10px">
                                <a href="#" data-toggle="modal" data-target="#ModalEdit2_@item.M.idPaciente"><b>Editar Datos</b></a>
                                <div class="dropdown-divider"></div>
                            </div>
                        </div>

                        <!-- Modal para editar-->
                        <form method="post" enctype="multipart/form-data" action="@Url.Content("~/CallCenter/EditarCompleto")">
                            @Html.AntiForgeryToken()
                            <div class="modal fade" id="ModalEdit2_@item.M.idPaciente" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
                                <div class="modal-dialog" role="document">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            @{
                                                if ((from i in db.Cita where i.Referencia == item.M.Referencia select i).Count() < 2)
                                                {
                                                    <h4 class="modal-title text-primary" id="exampleModalLabel"><b>Editar Datos</b></h4>
                                                }
                                                else
                                                {
                                                    <h4 class="modal-title text-primary" id="exampleModalLabel"><b>Editar Datos</b></h4>
                                                    <h5 class="modal-title text-danger" id="exampleModalLabel"><b>Este registro pertenece a un grupo de gestoría. Al modificar datos se aplicarán los cambios para todo el bloque.</b></h5>
                                                }
                                            }
                                        </div>
                                        <div class="modal-body">
                                            <div class="form-group">
                                                <label for="recipient-name" class="col-form-label">Nombre del Paciente:</label>
                                                <input type="text" class="form-control" id="nombre" name="nombre" placeholder="@item.N.Nombre">
                                                <input type="hidden" class="form-control" id="id" name="id" value="@item.N.idPaciente">
                                            </div>
                                            <div class="form-group">
                                                <label for="recipient-name" class="col-form-label">Teléfono:</label>
                                                <input type="text" class="form-control" id="telefono" name="telefono" placeholder="@item.N.Telefono" />
                                            </div>
                                            <div class="form-group">
                                                <label for="recipient-name" class="col-form-label">Email:</label>
                                                <input type="email" class="form-control" id="email" name="email" placeholder="@item.N.Email" />
                                            </div>
                                            <div class="form-group">
                                                <label for="recipient-name" class="col-form-label">Fecha de Cita:</label>
                                                <input type="date" class="form-control" id="fecha" name="fecha" required />
                                            </div>
                                        </div>
                                        <div class="modal-footer">
                                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
                                            <input type="submit" value="Guardar" class="btn btn-primary" />
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </form>

                    </td>
                </tr>

                flag += 1;

            }

        </table>
    </div>
}






